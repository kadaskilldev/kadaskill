<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>KadaSkill - Loading</title>
    <meta name="description" content="KadaSkill application loading screen" />
    <link rel="stylesheet" href="loading/globals.css" />
    <link rel="stylesheet" href="loading/styleguide.css" />
    <link rel="stylesheet" href="loading/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <main class="loading-screen" role="main">
        <section class="loading">
            <div class="authentication-page">
                <img class="icon" src="images/loading/icon.png" alt="KadaSkill loading robot mascot" onerror="this.style.display='none';" />
                <p class="text-wrapper" role="status" aria-live="polite">LOADING...</p>
            </div>
        </section>
        <header class="navigation-bar-get" aria-label="KadaSkill navigation">
            <div class="group"></div>
            <div class="div">
                <div class="logo-mark" aria-hidden="true">
                    <svg class="vector" width="51" height="40" viewBox="0 0 51 40">
              <image href="images/loading/Vector-2.svg" width="51" height="40" />
            </svg>
                    <svg class="img" width="30" height="30" viewBox="0 0 44 44">
              <image href="images/loading/Vector.svg" width="44" height="44" />
            </svg>
                    <svg class="vector-2" width="33" height="32" viewBox="0 0 33 32">
              <image href="images/loading/Vector-1.svg" width="33" height="32" />
            </svg>
                </div>
                <p class="kada-skill" aria-label="KadaSkill">
                    <span class="span">Kada</span><span class="text-wrapper-2">Skill</span>
                </p>
            </div>
        </header>
    </main>
    <script>
        // Use the same Supabase credentials
        const SUPABASE_URL = 'https://kbpbubsnadnhebgdggdy.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImticGJ1YnNuYWRuaGViZ2RnZ2R5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMjA4MTksImV4cCI6MjA3MzU5NjgxOX0.4O8ZLeZ2iR786MZ8JS_55nzhn-5WxqabMtDQuAoZkAA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // runs as soon as the page loads
        async function fetchInitialDataAndRedirect() {
            // Get the user from Supabase's local session
            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                // If for some reason no user is found, go back to the login page
                console.error("No user session found. Redirecting to login.");
                window.location.replace('index.html'); // Use replace to avoid back-button issues
                return;
            }

            // Fetch the user's profile from the database
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('full_name, total_xp') // Fetch all the data you need on the dashboard
                .eq('id', user.id)
                .single();

            if (error) {
                console.error("Failed to fetch profile:", error);
                // Handle the error, maybe go to login with an error message
                window.location.replace('index.html');
                return;
            }

            // Store the fetched user and profile data in sessionStorage.
            // sessionStorage is temporary storage that gets cleared when the browser tab is closed.
            // We use JSON.stringify because storage can only hold strings.
            sessionStorage.setItem('userProfile', JSON.stringify(profile));
            sessionStorage.setItem('authUser', JSON.stringify(user));

            // Now that the data is stored, redirect to the actual dashboard
            window.location.replace('learn.html');
        }

        // Run the function
        fetchInitialDataAndRedirect();
    </script>
</body>

</html>